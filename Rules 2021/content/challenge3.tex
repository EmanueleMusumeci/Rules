\section{Remote 5 vs 5 gameplay}
\label{sec:OneVsOneChallenge}

\subsection{Idea of the competition}
% Patrick
The aim of this competition is to explorer and demonstrate  competitive remote gameplay given the current situation.

Two teams of each five robots (no substitute) play against each other on a full-sized (\cf section \ref{sec:field_dim}) standard robot soccer according to sligtly modified SPL 2020 rules\change{TODO: See rules section} in a remote arena. 

This competition differs from the standard RoboCup procedure in the following aspects:
\begin{itemize}
    \item Remote deployment with manual or fully autonomous setup of NAO software and standardized settings for game play in a remote arena on foreign robots,
    \item Automatic or semi-automatic calibration of NAO (vision, motion, etc.), 
    \item Safe operation of robots in gameplay without damaging robots,
    \item Operating a hosting arena for remote teams. 
\end{itemize}

\subsection{Prerequisites}
\label{sec:c3_Prerequisites}
% Patrick

Requirements to participate in GORE are, being able to
\begin{itemize}
    \item send at least \textbf{four V6} NAOs equipped with a tiny USB stick (\cf section \ref{sec:c3_USB_Drive}) to the hosting arena,
    \item label each single part with your team's name
	\item deploy your robot's software remotely or fully autonomous setup, see \ref{sec:c3_BasicRequirementsForTeams}
	\item (optional) host an arena, see \ref{sec:c3_BasicRequirementsForArenas}
\end{itemize}

\subsubsection{Basic requirements for arenas}
\label{sec:c3_BasicRequirementsForArenas}
Teams have to fulfil the following items to be able to host an arena.

\begin{itemize}
    \item An SPL field (see \ref{sec:environment_setup}) corresponding to the standard SPL field size (\cf section \ref{sec:field_dim}).
	\item Wi-Fi with standard SPL\textunderscore A SSID, standard password (as communicated before the competition via e-mail) and standard IP \texttt{10.0.0.2} address and DHCP turned off
    \item Remote network access via VPN connection,
    \item Camera, tablet or laptop for on field online calibration with remote team using Discord
    \item Streaming setup, see~\ref{sec:streaming_setup}
	\item The latest Game Controller running
    \item All robots (own and send in) assigned for the whole competition are numbered from \textbf{1} to the maximum number with integers.
    \item At least \textbf{two} standard balls
    \item Assistants for remote setup and autonomous setup
    \item Referees (1 Head, 1 Game Controller Operator, $>= 2$ Assistants (Who are also volunteers for the teams in setup phases. They are also in the following game local representative for the teams.)
\end{itemize}

If you cannot fulfil all requirements (equipment or number of people in the field room, etc.) but you would like to host an arena, please contact the us.

\subsection{Arena and organizational setup}
\label{sec:arean-org-setup}
% Patrick
This competition relies on a standardized arena setup as well as on exchanging all information necessary for gameplay. The following sections define the information used to describe local arena conditions.

\subsubsection{USB Drive}
\label{sec:c3_USB_Drive}
Tiny (not standing out the surface of the head like \url{https://www.amazon.com/dp/B077VXV323/}) USB drives remaining inside the head for the whole game are used to flash a robot with a binary image or to store data during the game play of the robot.

During the competition two kinds of USB drive are used. Their purposes are:

\paragraph*{Flashing}
This kind of USB Drive is used to flash a robot either with the standard SoftBank image or with a team provided one. After flashing, this USB Drive gets replaced by the \textit{storage} USB drive.

\paragraph*{Storage}
After \textit{Flashing} a robot, a robot will be equipped with a storage USB drive with ext3 file system. It will be used for the following purposes:

\begin{itemize}
	\item \textbf{Configuration}: Configuration files, at least \texttt{field\_dimensions.json} as explained below, will be copied into the root folder of the USB drive.
	\item  \textbf{Logging}: If teams want to store log files or images and get them uploaded in the Nextcloud as explained below, they can store the files in a \texttt{logs} folder on the USB-Drive.
\end{itemize}

\subsubsection{Data Exchange}
\label{sec:data_exchange}
Teams exchange data before and during GORE using a Nextcloud drive. An access link and password will be sent to the team leaders and have to be used with care. The Nextcloud drive will contain a folder for every team according to their team number. Team folders will be used for sharing the following data:

\begin{itemize}
    \item In folder \textbf{field dimensions} each team has to provide a json file (template will be in the root folder of the drive) describing the field dimensions according to the rules (see \ref{sec:field_dim}). The file has to be named \texttt{field\_dimensions.json}. An example of this file you find in section~\ref{sec:fielddimensionsjson}. This file has to be uploaded until the \textbf{5th of May 2021}. The file will be used for autonomous setup and game play. To configure the arena the corresponding field description will be copied on the USB drive after flashing as \texttt{field\_dimensions.json} in the folder configuration. This allows the usage of the same image at different arenas.
    \item In \textbf{Robot Setup} the arena team find a binary image for a particular game. Each game has an identifier \textit{Game\_ID} and this identifier has to be used as folder name. The binary image has to be uploaded \textbf{two hours} before the game starts. Next to the image you can define a configuration file for each player. The containing files will be copied in the root on the USB drive. The USB drive will be plugged into the robot after flashing. Within this configuration folders you can also place files to configure your image. There is one mandatory file: \texttt{field\_dimensions.json}. This file has to be used by the robot's software.
    \item To allow an autonomous robot to identify the robot, 
    \item  In the folder \textbf{field images} each team has a folder where photos from the arena from different angles and at different day \& night-times with focus on the lighting conditions get uploaded until the \textbf{5th of May 2021}.
    \item In \textbf{Arena Access} remote teams find an instruction how to access the arena. Each team must provide team specific credentials and share them with the responsible person in each team until the \textbf{21st of April 2021}. Every hosting team has to announce a responsible person for credentials and remote setup until the \textbf{22nd of April 2021}. The list of responsible people can be found in the root folder of the Nextcloud drive.
    \item In the root folder you find a \texttt{streaming.md} file where every hosting team has to publish a link that can be used by public to watch a game. Further details for streaming, see~\ref{sec:streaming_setup}.
	\item Logs and images will be uploaded from the hosts into the folder \texttt{Team/Game\_ID/Logs}, where \textit{Game\_ID} is replaced by the game identifier, after the game when bandwidth is available. It is assumed that logs and images are stored on the USB drive attached to the NAO in the folder \texttt{logs}. Other files will be ignored. 

\end{itemize}

\subsubsection{Network Setup}
The following section defines network requirements for hosting remote games. The network infrastructure should be as transparent as possible for remote participants. It should get as close as possible to an on-site experience. Please also contact your local IT administrators and agree your setup with them.

\paragraph{General}

\begin{itemize}
    \item Participants need easy access to their robots for uploading code and debugging. No ports should be blocked. ICMP must not be blocked. % TODO: Which ports are necessary?
    \item Robots might accumulate a large amount of log files (including images). These logs will be uploaded after games for analysis. Minimum 100Mbit/s (symmetric) is recommended for a venue, favourable 1Gbit/s. Logs can also be uploaded from another network.
    \item To not overwhelm the network, teams should rate limit their network activity (in particular long log downloads and uncompressed video streams from NAOs during debug sessions)
\end{itemize}

\paragraph{SPL Game specific}

\begin{itemize}
    \item Team Messages (SPLStandardMessages) must be receivable for remote participants.
    \item Team Messages must not be forwarded from remote participants to 10.0.0.0/16 (SPL\_A).
    \item GameControllerMessages must be receivable for remote participants.
    \item GameControllerMessages must not be forwarded from remote participants to 10.0.0.0/16 to not allow remote participants to control the game (by accident).
\end{itemize}

\paragraph{Example configuration}

\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.5\textwidth]{figs/network.png}
    \caption{Network setup example}
\end{figure}

\begin{itemize}
    \item  The network could be divided for example into three subnets:
    \begin{itemize}
        \item 10.0.0.0/16: The actual SPL\_A wifi network on at least 2.4\,GHz. Each team must use 10.0.TEAM\_NO.2-254 for their robots. GameController will be on 10.0.0.2. DHCP is not active.
        \item 10.1.0.0/16: The ethernet network for robots. Each team must use 10.1.TEAM\_NO.2-254 for their robots. Static addressing is required when robots are assigned to a team. DHCP is active, statically assigning 10.1.0.2-255 to robots that are currently not assigned to any team (pool).
        \item 10.2.0.0/16: The VPN network. Remote participants are assigned to this network and can access the other networks. Team- and GameControllerMessages are forwarded from 10.0.0.0/16 to this subnet. DHCP is active. Broadcasting to other subnets is not possible.
    \end{itemize}
    \item Router (e.g. Ubiquiti EdgeRouter Lite 3-Port Router from Ubiquity \url{https://www.ui.com/edgemax/edgerouter-lite/})
    \begin{itemize}
        \item serves as router for the whole network.
        \item has a globally routable (and accessible) IPv4 address.
        \item hosts an OpenVPN Layer2 VPN Server
        \item opens a network port to allow incoming OpenVPN connections
        \item Every team gets one certificate to authenticate via OpenVPN (multiple connections allowed).
        \item Has broadcast forwarding rules in place to allow VPN users to receive Team-/GC-Messages.
        \item GameController computer is assigned 10.0.0.2/16
        \item \texttt{ETH0} could be connected to your university network and is preferably accessible from the internet on the specific port (please contact your computer center how to realize such a connection). If this is not possible, please check if you can make this network accessible from remote using a mobile internet connection. Or you provide a PC connected to an island network of this structure where people can access the PC using TeamViewer, remote desktop software, or something similar. 
    \end{itemize}
    \item Automate assignment of IP address to robots after being flashed.
    \begin{itemize}
        \item The hosting arenas prepare a table with the following columns: [Robot ID (1-16), Team, Head ID, Body ID, MAC address, IP address]
        \item Each team will fill in the data (Except IP Address) into the table for its robots until \textbf{26th of April 2021}.
        \item Each hosting team verifies this data when robots arrive.
        \item Each hosting team assigns static IP addresses to the robots based on the data in the table and lists the IP address there.
        \item This address can than be used by the teams to take over the robot after flashing. The Address has to be changed during configuration.
    \end{itemize}
\end{itemize}

If you have questions or problems to set your local network, please contact the TC via email. There will be also a Discord channel for networking to share configuration files and to solve problems.

\subsection{Remote \& Game Setup}
\label{sec:remote_game_setup}
This section describes the setup procedure for a 1 vs. 1 match\change{5 vs. 5}. The setup procedure distinguishes between fully-autonomous and semi-autonomous setup. The used setup procedure is relevant for scoring the game (\cf section \ref{sec:scoring}).

\subsubsection{Button Interface}
To give volunteers an interface to command autonomous acting robot, the following button interface sequences are defined:\change{Ich habe unten mal eine Zeichnung von meinem Verständis der Gamestates gemacht}
\begin{enumerate}
	\item \texttt{Head button front + Chest button}: Starting the autonomous calibration mode
	\item \texttt{1x Chest button}: Stiff robot
	\item \texttt{All three head buttons}: Unstiff robot
\end{enumerate} 

\subsubsection{Start: 2h before match}

    \begin{enumerate}
        \item Assignment of a volunteer from the host team for each remote team.\change{und evtl auch schon assistent wenn dies unterschiedliche Personen sind} They create own Discord rooms for communication during the whole setup and game phase and communicate this to the teams.
        \item Initial meeting of the volunteers and the representatives from the teams in one of the Discord rooms.
        \item Topics of this meeting are: Welcome, answering questions, agree on timing for calibration, and selecting robots.
		\item For each team one\change{5} randomly (see next points) selected functional robot is assigned from the pool.
		\begin{enumerate}
            \item The host team has a numbered list of functional robots from 1 to the maximum number.
            \item One volunteer screen shares a proper random number generator (\url{https://www.random.org/integers/}) with adjusted settings according to the number of available robots.
            \item The volunteer runs the number generator. The first number is the robot number for the home team, away team is second.\change{Anderes prozedere}
            \item If a robot, who wears the selected number, is already taken or not available, than the generator has to be run again. 
        \end{enumerate} 
        \item Move to the individual Discord rooms to shortly discuss the team specific setup, calibration and game play procedure with the volunteer.
        \item The competing team informs the competition venue if they are using fully-autonomous or semi-autonomous setup.
        \item Connect the robot (should already be fully charged) to a charger. If the competing team chose semi-autonomous setup, a LAN cable is connected as well.
        \item Each robot gets flashed 
        \begin{itemize}
            \item with the standard SoftBank binary image or
            \item with the image provided by the respective team.
		\end{itemize}
		\item Each robot gets equipped with a USB drive according to \ref{sec:c3_USB_Drive} and started.
        \item Teams can set their robot up remotely, if necessary. To reduce the amount of data transferred to set the robot up, teams should reduce this as much as they can and use installable images where possible. If the competing team chose fully-autonomous setup, this step is skipped.
        \item The IP address given by the DHCP Server has to be communicated from the local host to the remote team using Discord. If the competing team chose fully-autonomous setup, this step is skipped.
        \item According to the official game schedule, the first team named is the home team, plays on the left half of the field and the second called team is the away team and play on the right half of the field from the perspective of the GameController. 
        \item Dress robots with jerseys (see \ref{sec:team_markers}). The hosting team's 'home' and 'away' jersey are assigned to the 'home' and 'away' starting robot. 
    \end{enumerate}

\subsubsection{Calibration / Testing: 1 hour before match}
    \begin{enumerate}
        \item 20 minutes to calibrate the robot supported by one volunteer.
        \item The robot than can move over the whole field to calibrate itself. The robot has 10 minutes to calibrate. During this time the field has to stay empty. The volunteer has to actively watch the robot and to be ready to catch him as soon as it would leave the field or fall. The volunteer is allowed to catch the robot. To prevent damage the same rules as in normal game play have to be applied to prevent damage to the robot (see \ref{sec:rules_ref}).\change{Vielleicht sollte man einfach die 30 minuten jedem Team auf einer hälfte geben}
        \item Before the calibration starts, on each starting position a ball gets placed. The robot can move any ball. If a ball leaves the field, it gets replaced at its kick-in position (see \ref{sec:kick_in}). If a robot scores a goal, the ball gets moved back to its starting position. 
        \item \textbf{Automatic calibration} is conducted in the following way: The volunteer places the robot on the normal initial position at the field side of an empty field. Then the \texttt{front head button + chest button} gets pressed to initialize auto calibration mode~(see~\ref{sec:robot_states}).  At the end of the calibration period, the robot may sit down and get unstiffed. Otherwise, the robot will be unstiffed by the volunteer by pressing all head buttons simultaneously~(see~\ref{sec:robot_states}).
     
        \textbf{Semi-automatic calibration}: With support of a local volunteer the robot is calibrated remotely. Both volunteer and remote team meet in a Discord room and perform the calibration procedure of the remote team together.

        \item  Check Wi-Fi and game controller connection
    \end{enumerate}

\subsubsection{Game Setup}

	\begin{enumerate}
		\item Robots are in the game controller
		\item Robots sit on field on the game controller's side on their halves on the height of the penalty spot facing the field. With one button press on the chest button the robot has to get up stiffed in the upright position and is waiting for the ready signal from the game controller.\change{Für 5 anpassen möglichst einheitlich!}
		\item The game will be started using the game controller as \textit{Play-off game} and the robot moves to its starting position.
		\item In \texttt{Set} the balls will be placed and the game will be started using a whistle.
		\item In the second half the robots switch their sides.
		\item Referees apply rules with focus on preventing hardware damage, because there is no SoftBank Robotics support (see \ref{sec:rules_ref}).
		\item When robots receive the finish message they have to sit down and will be brought to the chargers and plugged into network.
	\end{enumerate}
	
\subsubsection{After Game}
	
	\begin{enumerate}
		\item After, robots received the finish state of the second half of the game controller they have to sit down.
		\item Robots have time to do all post-processing, storing the logs and shutting down.
		\item If robots are not switched off after 5 minutes they will be switched off manually.
		\item The data from the USB drive will be stored on another device and as soon as possible uploaded in the Nextcloud.
		\item Teams are not allowed to download their logs directly.
		\item Robots will be returned to pool for the next game.
	\end{enumerate}

\subsection{field\_dimensions.json example}
\label{sec:fielddimensionsjson}

\begin{lstlisting}[language=json,firstnumber=1]
{
    "field": {
        "length": 9.0,
        "width": 6.0,
        "lineWidth": 0.05,
        "penaltyMarkerSize": 0.1,
        "goalBoxAreaLength": 0.6,
        "goalBoxAreaWidth": 2.2,
        "penaltyAreaLength": 1.65,
        "penaltyAreaWidth": 4.0,
        "penaltyCrossDistance": 1.3,
        "centerCircleDiameter": 1.5,
        "borderStripWidth": 0.7
    },
    "goal": {
        "postDiameter": 0.1,
        "height": 0.8,
        "innerWidth": 1.5,
        "depth": 0.5
    }
}
\end{lstlisting}